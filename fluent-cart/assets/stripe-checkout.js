class Y{constructor(l,u,w){this.form=l,this.data=u,this.paymentArgs=u.payment_args,this.intent=u.intent,this.paymentLoader=w,this.$t=this.translate.bind(this)}translate(l){var w;return(((w=window.fct_stripe_data)==null?void 0:w.translations)||{})[l]||l}async init(){var x,L;const l=document.querySelector("[data-fluent-cart-checkout-page-checkout-button]"),u=document.querySelector(".fluent-cart-checkout_embed_payment_container_stripe"),w=this.form.querySelector(".fluent_cart_payment_methods");w&&(w.style.display="none");const n=this,t=Stripe((x=this.paymentArgs)==null?void 0:x.public_key),c={...this.intent};this.data.appearance&&(c.appearance=this.data.appearance);const r=await t.elements(c),y={fields:{billingDetails:{name:"never",email:"never"}},terms:{card:"never",wallet:"never",apple_pay:"never",google_pay:"never",amazon_pay:"never",paypal:"never"}},d=await r.create("payment",y);d.mount(".fluent-cart-checkout_embed_payment_container_stripe");const _=(L=window.fluentcart_checkout_vars)==null?void 0:L.submit_button;d.on("loaderror",function(o){var k,e,b;window.dispatchEvent(new CustomEvent("fluent_cart_payment_method_loading_failed",{detail:{payment_method:"stripe"}}));const p=document.getElementById("fct_loading_payment_processor");p&&p.remove();let s=(k=o==null?void 0:o.error)==null?void 0:k.message,m="";if(((e=window==null?void 0:window.fluentcart_checkout_info)==null?void 0:e.is_admin)!=="1"){s=n.$t("Payment module not available to checkout! Please reload again, or contact admin!"),m=`<p style="color:red; display:none;" class="hidden-error">${(b=o==null?void 0:o.error)==null?void 0:b.message}</p>`;const g=document.createElement("a");g.className="toggle-error",g.style.cursor="pointer",g.textContent=n.$t("See Errors"),g.addEventListener("click",function(){document.querySelector(".hidden-error").style.display=document.querySelector(".hidden-error").style.display==="none"?"block":"none"}),u.prepend(g)}const a=document.createElement("p");a.style.color="red",a.innerHTML=s+m,u.prepend(a),window.is_stripe_ready=!1,n.paymentLoader.disableCheckoutButton(_==null?void 0:_.text)}),d.on("ready",function(o){window.is_stripe_ready=!0,window.dispatchEvent(new CustomEvent("fluent_cart_payment_method_loading_success",{detail:{payment_method:"stripe"}}));const p=document.getElementById("fct_loading_payment_processor");if(p&&p.remove(),l&&l.id==="fluent_cart_custom_checkout_btn")n.paymentLoader.disableCheckoutButton(n.$t("Pay Now"));else{const s=n.form.querySelector('input[name="_fct_pay_method"]:checked');s&&s.value==="stripe"&&n.paymentLoader.enableCheckoutButton(_.text)}d.addEventListener("change",function(s){window.is_stripe_ready=s.complete,document.querySelectorAll(".fct-error-message").forEach(a=>a.remove()),window.is_stripe_ready?l&&l.id==="fluent_cart_custom_checkout_btn"?n.paymentLoader.enableCheckoutButton(n.$t("Pay Now")):n.paymentLoader.enableCheckoutButton(_.text):n.paymentLoader.disableCheckoutButton(_!=null&&_.text?_.text:n.$t("Place Order"))}),window.addEventListener("fluent_cart_payment_next_action_stripe",s=>{var T,$,I,N,B,C,O,A,H,U,j;(T=n.paymentLoader)==null||T.changeLoaderStatus("processing");const m=document.querySelector(".fct-loader");($=m==null?void 0:m.classList)==null||$.add("active");const a=(I=s.detail)==null?void 0:I.response;let k=(N=a==null?void 0:a.payment_args)==null?void 0:N.success_url;(B=a==null?void 0:a.payment_args)==null||B.custom_payment_url;const e=a==null?void 0:a.fc_customer;let b=null,g="intent";((C=a==null?void 0:a.response)==null?void 0:C.object)==="subscription"?(g=(A=(O=a==null?void 0:a.payment_args)==null?void 0:O.vendor_subscription_info)==null?void 0:A.type,b=(U=(H=a==null?void 0:a.payment_args)==null?void 0:H.vendor_subscription_info)==null?void 0:U.clientSecret):b=(j=a==null?void 0:a.response)==null?void 0:j.client_secret;const F=function(E){new Toastify({text:E,className:"warning",duration:2e3,escapeMarkup:!1,close:!0}).showToast()};r.submit().then(E=>{const S=g==="setup"?t.confirmSetup:t.confirmPayment,P=g==="setup"?"setupIntent":"paymentIntent",G={elements:r,clientSecret:b,confirmParams:{return_url:k,payment_method_data:{billing_details:{address:{city:e!=null&&e.city?e==null?void 0:e.city:null,country:e!=null&&e.country?e==null?void 0:e.country:null,postal_code:e!=null&&e.postcode?e==null?void 0:e.postcode:null,state:e!=null&&e.state?e==null?void 0:e.state:null,line1:e!=null&&e.address_1?e==null?void 0:e.address_1:null},name:e==null?void 0:e.name,email:e==null?void 0:e.email}}},redirect:"if_required"};S(G).then(h=>{var D,Q,J,X,z;(D=n.paymentLoader)==null||D.changeLoaderStatus("confirming"),h!=null&&h.error&&(console.log("inside error",(Q=h==null?void 0:h.error)==null?void 0:Q.message),n.paymentLoader.enableCheckoutButton(_.text),F((J=h==null?void 0:h.error)==null?void 0:J.message),(X=n.paymentLoader)==null||X.hideLoader());const i=h[P];if(i!=null&&i.status&&(i.status==="succeeded"||i.status==="processing"||i.status==="requires_capture")){(z=n.paymentLoader)==null||z.changeLoaderStatus("completed");const K=new URLSearchParams(window.location.search).get("mode")||"order",V=new URLSearchParams({action:"fluent_cart_confirm_stripe_payment",intentId:i.id,mode:K}).toString(),f=new XMLHttpRequest;f.open("POST",window.fluentcart_checkout_vars.ajaxurl,!0),f.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),f.onreadystatechange=function(){var W;if(f.readyState===4)if(f.status>=200&&f.status<300){(W=n.paymentLoader)==null||W.changeLoaderStatus("redirecting");let M=JSON.parse(f.responseText);M&&(n.paymentLoader.triggerPaymentCompleteEvent(M),M.redirect_url&&(k=M.redirect_url)),window.CheckoutHelper?window.CheckoutHelper.handleCheckoutRedirect(k):window.location.href=k}else console.log(f.responseText,"failed")},f.onerror=function(){console.log("Request failed")},f.send(V)}else if((i==null?void 0:i.status)==="requires_action"||(i==null?void 0:i.status)==="requires_source_action")return q(i)})}).catch(E=>{var S,P;console.log(E,"failed"),m.classList.remove("active"),(S=n.paymentLoader)==null||S.changeLoaderStatus("failed"),(P=n.paymentLoader)==null||P.hideLoader()})})});const q=o=>{var s,m;(s=n.paymentLoader)==null||s.changeLoaderStatus(n.$t("redirecting for action"));const p=(m=o.next_action)==null?void 0:m.type;switch(p){case"redirect_to_url":window.location.href=o.next_action.redirect_to_url.url;break;case"cashapp_handle_redirect_or_display_qr_code":o.next_action.cashapp_handle_redirect_or_display_qr_code.hosted_instructions_url?window.location.href=o.next_action.cashapp_handle_redirect_or_display_qr_code.hosted_instructions_url:console.log("QR Code:",o.next_action.cashapp_handle_redirect_or_display_qr_code.qr_code);break;case"display_boleto":window.location.href=o.next_action.boleto_display_details.hosted_voucher_url;break;case"oxxo_display_details":window.location.href=o.next_action.oxxo_display_details.hosted_voucher_url;break;case"alipay_handle_redirect":window.location.href=o.next_action.alipay_handle_redirect.url;break;case"konbini_display_details":window.location.href=o.next_action.konbini_display_details.hosted_voucher_url;break;case"display_bank_transfer_instructions":window.location.href=o.next_action.display_bank_transfer_instructions.hosted_instructions_url;break;case"verify_with_microdeposits":window.location.href=o.next_action.verify_with_microdeposits.hosted_verification_url;break;case"wechat_pay_display_qr_code":o.next_action.wechat_pay_display_qr_code.hosted_instructions_url?window.location.href=o.next_action.wechat_pay_display_qr_code.hosted_instructions_url:console.log("QR Code:",o.next_action.wechat_pay_display_qr_code.qr_code);break;case"promptpay_display_qr_code":o.next_action.promptpay_display_qr_code.hosted_instructions_url?window.location.href=o.next_action.promptpay_display_qr_code.hosted_instructions_url:console.log("QR Code:",o.next_action.promptpay_display_qr_code.qr_code);break;default:console.error("Unsupported next_action type:",p);break}};window.addEventListener("fluent_cart_validate_checkout_stripe",function(o){if(!window.is_stripe_ready){const p=document.createElement("div");p.className="fct-error-message",p.textContent=n.$t("Card details are not valid!"),document.querySelector(".fluent-cart-checkout-page-checkout-form-order-summary").appendChild(p),t.confirmPayment({elements:r,confirmParams:{return_url:"https://stripe.com"},redirect:"if_required"})}})}}window.addEventListener("fluent_cart_load_payments_stripe",function(v){window.dispatchEvent(new CustomEvent("fluent_cart_payment_method_loading",{detail:{payment_method:"stripe"}})),window.fluentcart.$t;const l=document.querySelector(".fluent-cart-checkout_embed_payment_container_stripe");n(),w(),fetch(v.detail.paymentInfoUrl,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":v.detail.nonce},credentials:"include"}).then(async t=>{var r,y,d;if(t=await t.json(),(t==null?void 0:t.status)==="failed"&&u(t==null?void 0:t.message),((r=t==null?void 0:t.intent)==null?void 0:r.amount)<=0&&((y=t==null?void 0:t.intent)==null?void 0:y.mode)!=="subscription"){let q=function(L){return _[L]||L};var c=q;const _=((d=window.fct_stripe_data)==null?void 0:d.translations)||{};u(q("Total amount is not valid, please add some items to cart!"));const x=document.getElementById("fct_loading_payment_processor");x&&x.remove();return}new Y(v.detail.form,t,v.detail.paymentLoader).init()}).catch(t=>{var y;const c=((y=window.fct_stripe_data)==null?void 0:y.translations)||{};function r(d){return c[d]||d}u(r("An error occurred while parsing the response."))});function u(t){if(!t)return;const c=document.createElement("div");c.className="fct-error-message",c.textContent=t,l.appendChild(c);const r=document.getElementById("fct_loading_payment_processor");r&&r.remove()}function w(){var y;const t=document.createElement("p");t.id="fct_loading_payment_processor";const c=((y=window.fct_stripe_data)==null?void 0:y.translations)||{};function r(d){return c[d]||d}t.textContent=r("Loading Payment Processor..."),l.appendChild(t)}function n(){document.querySelectorAll(".fct-error-message").forEach(c=>c.remove())}});
